description = 'RDForward E2E - Visual regression tests with real Minecraft clients'

dependencies {
    testImplementation project(':rd-server')
    testImplementation project(':rd-protocol')
    testImplementation project(':rd-world')
    testImplementation 'com.github.romankh3:image-comparison:4.4.0'
}

// E2E tests require Xvfb + Java 8 + real client JARs. Skip during normal builds;
// run explicitly with: ./gradlew :rd-e2e:test -Pe2e
// Parallel execution: each test class runs in its own fork with isolated Xvfb display
// and temp data directory. Pre-1.19 clients get high parallelism; 1.19+ get max 3.
test {
    onlyIf { project.hasProperty('e2e') }
    timeout = java.time.Duration.ofMinutes(20)
    // Run from root project directory so relative paths (rd-e2e-agent/build/libs/,
    // rd-client/build/libs/, rd-e2e/libs/, rd-e2e/baselines/) resolve correctly.
    workingDir = rootProject.projectDir
    // Run test classes in parallel across forks. Each fork gets a unique
    // org.gradle.test.worker ID used by HeadlessDisplay.forFork() for display isolation
    // and by E2ETestServer for temp data directory isolation.
    maxParallelForks = Math.max(Runtime.runtime.availableProcessors().intdiv(2), 4)
    // Show stdout/stderr from tests (agent output, download progress, etc.)
    testLogging {
        showStandardStreams = true
    }

    // Pre-1.19 test classes only (RubyDung, Alpha, Beta, CrossVersion)
    include '**/scenarios/RubyDung*Test.class'
    include '**/scenarios/Alpha*Test.class'
    include '**/scenarios/Beta*Test.class'
    include '**/scenarios/CrossVersion*Test.class'
}

// Separate task for 1.19+ clients with lower parallelism (heavier JVMs)
tasks.register('testModern', Test) {
    onlyIf { project.hasProperty('e2e') }
    timeout = java.time.Duration.ofMinutes(30)
    workingDir = rootProject.projectDir
    maxParallelForks = 3
    classpath = sourceSets.test.runtimeClasspath
    testClassesDirs = sourceSets.test.output.classesDirs
    testLogging {
        showStandardStreams = true
    }

    include '**/scenarios/Release119*Test.class'
    include '**/scenarios/Release120*Test.class'
    include '**/scenarios/Release121*Test.class'
}

// Convenience task to run both pre-1.19 and modern test suites
tasks.register('testAll') {
    dependsOn test, tasks.named('testModern')
}

// Ensure the agent fat JAR and modded client JAR are built before tests run
tasks.named('test') {
    dependsOn ':rd-e2e-agent:fatJar'
    dependsOn ':rd-client:fatModdedJar'
}
tasks.named('testModern') {
    dependsOn ':rd-e2e-agent:fatJar'
    dependsOn ':rd-client:fatModdedJar'
}
